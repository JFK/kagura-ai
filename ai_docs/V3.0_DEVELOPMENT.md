# Kagura AI v3.0 Development Guide

**Date**: 2025-10-19
**Purpose**: v3.0é–‹ç™ºã®å®Ÿè·µçš„ã‚¬ã‚¤ãƒ‰

---

## ğŸ¯ v3.0ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

### SDKè»¸ã€Chatã¯ãƒœãƒ¼ãƒŠã‚¹

**ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: Pythoné–‹ç™ºè€…ï¼ˆã‚¢ãƒ—ãƒªã¸ã®SDKçµ±åˆï¼‰
**ãƒœãƒ¼ãƒŠã‚¹**: Chatã§æ‰‹è»½ã«è©¦ã›ã‚‹ï¼ˆå®Ÿé¨“ãƒ»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼‰

**ç†ç”±**: GitHubã¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‘ã‘ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 

---

## ğŸ“ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 3å±¤æ§‹é€ ï¼ˆç°¡ç•¥ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Developer SDK             â”‚
â”‚  - from kagura import agent         â”‚
â”‚  - Type-safe, Production-ready      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ also provides
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Built-in Tools & Agents   â”‚
â”‚  - Web search, File ops, Code exec  â”‚
â”‚  - Personal tools (news, weather)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ showcased in
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Interactive Chat (Bonus)  â”‚
â”‚  - kagura chat (è©¦ã™ãƒ»å®Ÿé¨“ç”¨)      â”‚
â”‚  - Claude Code-like UX              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ é–‹ç™ºå„ªå…ˆåº¦

### ğŸ”¥ Critical

1. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåˆ·æ–°** (Issue #315)
   - README: SDK-first
   - CLAUDE.md: ç°¡ç´ åŒ–
   - Examples: v2.6.0å¯¾å¿œ + SDKçµ±åˆä¾‹

2. **SDKåŒ–æ¨é€²**
   - `__init__.py` exportsæ‹¡å¼µ
   - Personal toolsç›´æ¥import
   - Built-in toolsç›´æ¥import

### â­ï¸ High

3. **Chatæ©Ÿèƒ½å¼·åŒ–** (v3.0å®Œæˆã¸)
   - `/create` commandï¼ˆMeta Agentï¼‰
   - `/stats` commandï¼ˆã‚³ã‚¹ãƒˆå¯è¦–åŒ–ï¼‰
   - `/reload` commandï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†èª­è¾¼ï¼‰

4. **Examplesæ‹¡å……**
   - SDKçµ±åˆä¾‹ï¼ˆFastAPI, Streamlitï¼‰
   - Personal toolsä½¿ç”¨ä¾‹
   - Real-world use cases

### ğŸ“š Medium

5. **RFC-033 Phase 1** - Auto-Discovery
6. **Pre-installed Agents** - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

---

## ğŸ› ï¸ é–‹ç™ºãƒ•ãƒ­ãƒ¼

### æ¨™æº–ãƒ•ãƒ­ãƒ¼

```bash
# 1. Issueä½œæˆ
gh issue create --title "feat(scope): description" --body "..."

# 2. Branchã‚’ä½œæˆ
gh issue develop [ç•ªå·] --checkout

# 3. å®Ÿè£…ï¼ˆTDDï¼‰
# ãƒ†ã‚¹ãƒˆ â†’ å®Ÿè£… â†’ å‹ãƒã‚§ãƒƒã‚¯ãƒ»lint

# 4. ã‚³ãƒŸãƒƒãƒˆ
git add .
git commit -m "feat(scope): ... (#XX)

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# 5. Draft PR
gh pr create --draft --title "..." --body "..."

# 6. CIé€šé â†’ Merge
gh pr ready [ç•ªå·]
gh pr merge [ç•ªå·] --squash
```

---

## ğŸ“ å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### @agent ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿

```python
from kagura import agent

@agent(
    model="gpt-5-mini",           # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«
    temperature=0.7,              # æ¸©åº¦è¨­å®š
    enable_memory=True,           # ãƒ¡ãƒ¢ãƒªæœ‰åŠ¹åŒ–
    tools=["web_search"],         # Built-in tools
    stream=True,                  # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
)
async def my_agent(query: str) -> str:
    '''ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: {{ query }}'''
```

### Custom Tools

```python
from kagura import tool

@tool
async def custom_tool(input: str) -> str:
    '''ãƒ„ãƒ¼ãƒ«èª¬æ˜'''
    # å®Ÿè£…
    return result
```

### Memoryæ´»ç”¨

```python
@agent(enable_memory=True)
async def assistant(message: str, memory: MemoryManager) -> str:
    '''{{ message }}'''

    # Memory APIã¯è‡ªå‹•æ³¨å…¥
    # await memory.recall(key)
    # await memory.store(key, value)
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```python
import pytest
from kagura import agent

@pytest.mark.asyncio
async def test_agent_basic():
    @agent
    async def test_agent(query: str) -> str:
        '''Process: {{ query }}'''

    result = await test_agent("hello")
    assert isinstance(result, str)
    assert len(result) > 0
```

### LLM Mocking

```python
from kagura.testing.mocking import LLMMock

@pytest.mark.asyncio
async def test_with_mock():
    with LLMMock("Mocked response"):
        result = await my_agent("test")
        assert "Mocked response" in result
```

---

## ğŸ“Š v3.0é€²æ—

### å®Œäº†æ¸ˆã¿ (v2.7.x)
- âœ… Streaming support
- âœ… User config (`kagura init`)
- âœ… Personal tools (4å€‹)
- âœ… Context compression
- âœ… MCP integration

### é€²è¡Œä¸­ (v3.0)
- ğŸ”„ Documentation refresh (Issue #315)
- ğŸ”„ SDK exportsæ‹¡å¼µ
- ğŸ”„ Examplesæ›´æ–°

### æœªå®Ÿè£… (v3.0ãƒªãƒªãƒ¼ã‚¹å‰)
- â³ Chat `/create` command
- â³ Chat `/stats` command
- â³ Chat `/reload` commandå®Œæˆ

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `ROADMAP_v3.md` - v3.0ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—
- `V3.0_PIVOT.md` - v3.0æ–¹é‡è»¢æ›ã®èƒŒæ™¯
- `V3.0_WORK_LOG.md` - ä½œæ¥­ãƒ­ã‚°
- `CODING_STANDARDS.md` - ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„
- `VISION.md` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ“ã‚¸ãƒ§ãƒ³

---

## ğŸ“ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### @agentãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã®å‹ã®ä¸€è²«æ€§

**é‡è¦**: `@agent`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã¯é–¢æ•°ã®è¿”ã‚Šå€¤å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å°Šé‡ã—ã¾ã™ã€‚

```python
# âœ… Good: å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¨å®Ÿéš›ã®è¿”ã‚Šå€¤ãŒä¸€è‡´
@agent
async def get_summary(text: str) -> str:
    """Summarize: {{ text }}"""
    ...

result = await get_summary("...")
assert isinstance(result, str)  # âœ… Passes

# âœ… Good: Pydantic modelã‚’è¿”ã™
@agent
async def extract_data(text: str) -> Person:
    """Extract person info from: {{ text }}"""
    ...

result = await extract_data("...")
assert isinstance(result, Person)  # âœ… Passes

# âŒ Bad: å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç„¡ã—ã§LLMResponseãŒè¿”ã‚‹
@agent
async def get_news(topic: str):  # No return type annotation
    """Get news about: {{ topic }}"""
    ...

result = await get_news("AI")
# result is LLMResponse object, not str! âŒ
```

**å†…éƒ¨å®Ÿè£…**:
- `-> str`ã®å ´åˆ: `LLMResponse.content`ã‚’è¿”ã™
- Pydanticãƒ¢ãƒ‡ãƒ«ã®å ´åˆ: JSONãƒ‘ãƒ¼ã‚¹ã—ã¦æ¤œè¨¼æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’è¿”ã™
- å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç„¡ã—ã®å ´åˆ: `LLMResponse`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™

### ãƒ†ã‚¹ãƒˆä½œæˆæ™‚ã®LLMMockä½¿ç”¨

```python
from kagura.testing.mocking import LLMMock

@pytest.mark.asyncio
async def test_my_agent():
    """Test with mocked LLM response"""
    with LLMMock("Mocked response content"):
        result = await my_agent("test input")
        assert isinstance(result, str)
        assert "Mocked response" in result
```

**LLMMockã®å‹•ä½œ**:
- OpenAI SDK, LiteLLM, Gemini SDKã‚’ã™ã¹ã¦ãƒ¢ãƒƒã‚¯
- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã‚’å›é¿
- æ±ºå®šçš„ãªãƒ†ã‚¹ãƒˆçµæœã‚’ä¿è¨¼

### hasattrã‚’ä½¿ã£ãŸDuck Typing

å¾ªç’°ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚„å‹ãƒã‚§ãƒƒã‚¯é…å»¶ã‚’é¿ã‘ã‚‹ãŸã‚ã€`isinstance`ã®ä»£ã‚ã‚Šã«`hasattr`ã‚’ä½¿ç”¨ï¼š

```python
# âŒ Avoid: isinstance with import
from kagura.core.llm import LLMResponse
if isinstance(response, LLMResponse):
    return response.content

# âœ… Prefer: hasattr for duck typing
if hasattr(response, "content"):
    return response.content  # type: ignore
```

---

**v3.0ã§Kagura AIã‚’æœ€é«˜ã®Python AI SDKã«ã—ã¾ã—ã‚‡ã†ï¼** ğŸš€
