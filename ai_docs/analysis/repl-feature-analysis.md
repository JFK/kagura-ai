# REPLæ©Ÿèƒ½åˆ†æã¨æ”¹å–„ææ¡ˆ

**Date**: 2025-10-03
**Scope**: CLI/REPLæ©Ÿèƒ½ã®ç¾çŠ¶ç¢ºèªã¨æ”¹å–„ææ¡ˆ

---

## ğŸ“Š ç¾åœ¨å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹æ©Ÿèƒ½

### CLI Commands
```bash
kagura version    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º
kagura repl       # REPLèµ·å‹•
```

### REPL Commands
- `/help` - ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
- `/agents` - å®šç¾©æ¸ˆã¿ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸€è¦§
- `/model [name]` - ãƒ¢ãƒ‡ãƒ«è¨­å®š
- `/temp [value]` - temperatureè¨­å®š
- `/exit` - çµ‚äº†
- `/clear` - ç”»é¢ã‚¯ãƒªã‚¢

### Core Features
1. **@agentãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿** - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©
2. **LiteLLMçµ±åˆ** - ç’°å¢ƒå¤‰æ•°ã‹ã‚‰APIã‚­ãƒ¼è‡ªå‹•èª­ã¿å–ã‚Š
3. **REPL** - åŸºæœ¬çš„ãªå¯¾è©±ç’°å¢ƒ
4. **Code Executor** - å®‰å…¨ãªã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ

---

## âŒ å®Ÿè£…ã•ã‚Œã¦ã„ãªã„æ©Ÿèƒ½

### 1. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ°¸ç¶šåŒ–
**ç¾çŠ¶**: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ¶ˆå¤±

**å•é¡Œ**:
- REPLã‚’é–‰ã˜ã‚‹ã¨å®šç¾©ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå…¨ã¦æ¶ˆãˆã‚‹
- æ¯å›ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å†å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**:
```python
# ç¾åœ¨ï¼ˆä¸ä¾¿ï¼‰
$ kagura repl
>>> @agent
... async def my_agent(...): ...

# REPLã‚’çµ‚äº†ã™ã‚‹ã¨æ¶ˆãˆã‚‹
>>> /exit

# æ¬¡å›REPLã‚’èµ·å‹•ã™ã‚‹ã¨ã€ã¾ãŸå®šç¾©ã—ç›´ã™å¿…è¦ãŒã‚ã‚‹
$ kagura repl
>>> @agent  # ã¾ãŸæ›¸ãç›´ã—
... async def my_agent(...): ...
```

---

### 2. .envãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µãƒãƒ¼ãƒˆ
**ç¾çŠ¶**: LiteLLMãŒç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿å–ã‚‹ãŒã€.envãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•èª­ã¿è¾¼ã¿ãªã—

**å•é¡Œ**:
- æ¯å› `export OPENAI_API_KEY=...` ãŒå¿…è¦
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®è¨­å®šãŒé›£ã—ã„

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**:
```bash
# ç¾åœ¨ï¼ˆä¸ä¾¿ï¼‰
$ export OPENAI_API_KEY=sk-...
$ export ANTHROPIC_API_KEY=sk-ant-...
$ kagura repl

# æœŸå¾…ã™ã‚‹å‹•ä½œ
$ cat .env
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
DEFAULT_MODEL=gpt-4o-mini
DEFAULT_TEMPERATURE=0.7

$ kagura repl  # .envã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
```

---

### 3. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
**ç¾çŠ¶**: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µãƒãƒ¼ãƒˆãªã—

**å•é¡Œ**:
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã€temperatureãªã©ã‚’æ°¸ç¶šåŒ–ã§ããªã„
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®è¨­å®šä¸å¯

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**:
```yaml
# .kagura.yaml
model: gpt-4o-mini
temperature: 0.7
max_tokens: 2000

agents_dir: ./my_agents  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¿å­˜å…ˆ
history_file: ~/.kagura_history
```

---

### 4. REPLå±¥æ­´ä¿å­˜
**ç¾çŠ¶**: ä¸Šä¸‹ã‚­ãƒ¼ã§å±¥æ­´ã‚’é¡ã‚Œãªã„

**å•é¡Œ**:
- å‰ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å†å®Ÿè¡Œã§ããªã„
- é•·ã„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©ã‚’å†å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

**æœŸå¾…ã™ã‚‹å‹•ä½œ**:
```python
>>> await hello("World")
'Hello, World!'

# ä¸Šã‚­ãƒ¼ã‚’æŠ¼ã™ã¨å‰ã®ã‚³ãƒãƒ³ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹
>>> await hello("World")  # â† è‡ªå‹•ã§è¡¨ç¤º

# ~/.kagura_history ã«ä¿å­˜ã•ã‚Œã‚‹
```

---

### 5. ç°¡æ˜“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©ã‚³ãƒãƒ³ãƒ‰
**ç¾çŠ¶**: æ¯å›`@agent`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã§å®šç¾©

**å•é¡Œ**:
- ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å…¥åŠ›ãŒå¿…è¦
- `from kagura import agent` ã‚’æ¯å›æ›¸ãå¿…è¦ãŒã‚ã‚‹ï¼ˆå®Ÿéš›ã¯ä¸è¦ã ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ··ä¹±ï¼‰

**æ”¹å–„æ¡ˆ**:
```python
# ç¾åœ¨ï¼ˆå†—é•·ï¼‰
>>> from kagura import agent
>>> @agent
... async def hello(name: str) -> str:
...     '''Say hello to {{ name }}'''
...     pass

# æ”¹å–„æ¡ˆ
>>> /agent hello(name: str) -> str
... Say hello to {{ name }}
Agent 'hello' defined

>>> await hello("World")
'Hello, World!'
```

---

## ğŸ¯ æ”¹å–„ææ¡ˆ

### Priority 1: å¿…é ˆï¼ˆBetaç‰ˆãƒªãƒªãƒ¼ã‚¹å‰ï¼‰

#### 1. .envãƒ•ã‚¡ã‚¤ãƒ«ã‚µãƒãƒ¼ãƒˆ
**å®Ÿè£…å†…å®¹**:
```python
# src/kagura/cli/main.py
from dotenv import load_dotenv

@cli.command()
def repl():
    load_dotenv()  # .envã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
    # ...
```

**ä¾å­˜é–¢ä¿‚**:
```toml
dependencies = [
    "python-dotenv>=1.0",
]
```

**æ‰€è¦æ™‚é–“**: 30åˆ†

---

#### 2. REPLå±¥æ­´ä¿å­˜ï¼ˆreadlineï¼‰
**å®Ÿè£…å†…å®¹**:
```python
# src/kagura/cli/repl.py
import readline
import os

class KaguraREPL:
    def __init__(self):
        self.history_file = os.path.expanduser("~/.kagura_history")
        self._load_history()

    def _load_history(self):
        if os.path.exists(self.history_file):
            readline.read_history_file(self.history_file)

    def _save_history(self):
        readline.write_history_file(self.history_file)
```

**æ‰€è¦æ™‚é–“**: 1æ™‚é–“

---

### Priority 2: æ¨å¥¨ï¼ˆBetaç‰ˆå¾Œï¼‰

#### 3. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ°¸ç¶šåŒ–
**å®Ÿè£…å†…å®¹**:
```python
# ~/.kagura/agents/my_agent.py ã¨ã—ã¦ä¿å­˜
/save my_agent  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä¿å­˜
/load my_agent  # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèª­ã¿è¾¼ã¿
/agents --saved # ä¿å­˜æ¸ˆã¿ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸€è¦§
```

**è¨­è¨ˆ**:
```
~/.kagura/
  agents/
    my_agent.py
    data_extractor.py
  history
  config.yaml
```

**æ‰€è¦æ™‚é–“**: 3æ™‚é–“

---

#### 4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚µãƒãƒ¼ãƒˆ
**å®Ÿè£…å†…å®¹**:
```yaml
# .kagura.yaml
model: gpt-4o-mini
temperature: 0.7
agents_dir: ~/.kagura/agents
history_file: ~/.kagura_history
auto_load_agents: true
```

**æ‰€è¦æ™‚é–“**: 2æ™‚é–“

---

#### 5. /agentã‚³ãƒãƒ³ãƒ‰ï¼ˆç°¡æ˜“å®šç¾©ï¼‰
**å®Ÿè£…å†…å®¹**:
```python
def execute_command(self, command: str):
    # ...
    elif cmd == "/agent":
        self._create_agent_from_command(arg)
```

**æ‰€è¦æ™‚é–“**: 2æ™‚é–“

---

## ğŸ“‹ å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: Quick Winsï¼ˆBetaç‰ˆå‰ï¼‰
**æ‰€è¦æ™‚é–“**: 1.5æ™‚é–“

1. `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µãƒãƒ¼ãƒˆï¼ˆ30åˆ†ï¼‰
2. REPLå±¥æ­´ä¿å­˜ï¼ˆ1æ™‚é–“ï¼‰

**æœŸå¾…åŠ¹æœ**:
- âœ… APIã‚­ãƒ¼è¨­å®šãŒç°¡å˜ã«
- âœ… ã‚³ãƒãƒ³ãƒ‰å±¥æ­´ãŒä½¿ãˆã‚‹
- âœ… åŸºæœ¬çš„ãªREPLä½“é¨“å‘ä¸Š

---

### Phase 2: Persistenceï¼ˆBetaç‰ˆå¾Œï¼‰
**æ‰€è¦æ™‚é–“**: 7æ™‚é–“

3. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ°¸ç¶šåŒ–ï¼ˆ3æ™‚é–“ï¼‰
4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚µãƒãƒ¼ãƒˆï¼ˆ2æ™‚é–“ï¼‰
5. `/agent`ã‚³ãƒãƒ³ãƒ‰ï¼ˆ2æ™‚é–“ï¼‰

**æœŸå¾…åŠ¹æœ**:
- âœ… ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å†åˆ©ç”¨å¯èƒ½
- âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®è¨­å®š
- âœ… ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®šç¾©ãŒç°¡å˜ã«

---

## ğŸš€ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### ä»Šã™ãå®Ÿæ–½ï¼ˆBetaç‰ˆå‰ï¼‰

**Issueä½œæˆ**: `[CLI-003] Add .env support and readline history to REPL`

**å†…å®¹**:
1. python-dotenvã§.envè‡ªå‹•èª­ã¿è¾¼ã¿
2. readlineã§ã‚³ãƒãƒ³ãƒ‰å±¥æ­´ä¿å­˜
3. ãƒ†ã‚¹ãƒˆè¿½åŠ 

**æœŸå¾…çµæœ**: REPLä½¿ã„ã‚„ã™ã•å¤§å¹…å‘ä¸Š

---

### Betaç‰ˆå¾Œã«å®Ÿæ–½

**Issueä½œæˆ**: `[CLI-004] Add agent persistence and config file support`

**å†…å®¹**:
1. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¿å­˜ãƒ»èª­ã¿è¾¼ã¿æ©Ÿèƒ½
2. .kagura.yamlè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
3. `/save`, `/load`, `/agent`ã‚³ãƒãƒ³ãƒ‰

---

## ğŸ“Š å„ªå…ˆåº¦ãƒãƒˆãƒªã‚¯ã‚¹

| æ©Ÿèƒ½ | å®Ÿè£…é›£æ˜“åº¦ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾¡å€¤ | å„ªå…ˆåº¦ |
|------|-----------|------------|--------|
| .env ã‚µãƒãƒ¼ãƒˆ | ä½ | é«˜ | â­â­â­ |
| readlineå±¥æ­´ | ä½ | é«˜ | â­â­â­ |
| ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ°¸ç¶šåŒ– | ä¸­ | ä¸­ | â­â­ |
| è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« | ä¸­ | ä¸­ | â­â­ |
| /agentã‚³ãƒãƒ³ãƒ‰ | ä¸­ | ä½ | â­ |

---

## ğŸ“ çµè«–

**ç¾çŠ¶**: åŸºæœ¬æ©Ÿèƒ½ã¯å®Ÿè£…æ¸ˆã¿ã€REPLã®ä½¿ã„ã‚„ã™ã•ã«èª²é¡Œ

**æ¨å¥¨**:
1. Phase 1ï¼ˆ.env + readlineï¼‰ã‚’**Betaç‰ˆå‰**ã«å®Ÿè£…
2. Phase 2ï¼ˆæ°¸ç¶šåŒ– + è¨­å®šï¼‰ã‚’**Betaç‰ˆå¾Œ**ã«å®Ÿè£…

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: Issue #56ã‚’ä½œæˆã—ã¦ã€Phase 1ã‚’å®Ÿè£…

---

**å‚è€ƒå®Ÿè£…ä¾‹**:

**IPython**: readlineå±¥æ­´ã€magic commands
**Poetry**: pyproject.tomlè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
**AWS CLI**: ~/.aws/configè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
