# Work Log - 2025-10-23

## Summary
v3.0.8リリース - MCP Tools強化とRAG Auto-detect機能実装

## Completed Issues

### Issue #354: [RFC] Change enable_rag default to True for better UX
**Status:** Closed
**PR:** #356
**Impact:** High - UX improvement

**Implementation:**
- Option 2 (Auto-detect) を採用
- `enable_rag: Optional[bool] = None` - chromadb利用可能時に自動有効化
- 明示的な`True`/`False`で上書き可能
- 後方互換性完全維持

**Changes:**
- `src/kagura/core/memory/manager.py`: Auto-detect logic追加
- `src/kagura/builder/agent_builder.py`: `with_memory()` 更新
- `src/kagura/builder/config.py`: `MemoryConfig` 更新
- `tests/core/test_memory_rag.py`: 3つの新規テスト追加
- `docs/en/api/memory.md`: ドキュメント更新

**Test Results:**
- 121 memory tests passed
- Type checking: 0 errors
- All backward compatible

---

### Issue #355: [BUG] Memory not shared across chat threads
**Status:** Closed
**PR:** #358
**Impact:** Critical - Cross-thread memory sharing

**Implementation:**
- Issue #357のアプローチを採用（description-driven behavior）
- MCP memory toolsのdocstring強化
- `agent_name="global"` でスレッド間共有を実現
- `agent_name="thread_specific"` でスレッド分離

**Changes:**
- `src/kagura/mcp/builtin/memory.py`:
  - `memory_store`: agent_name使い分けガイド追加
  - `memory_recall`: 同様のガイド追加
  - `memory_search`: 検索スコープガイド追加
  - `memory_list`: 新規デバッグツール追加

**New Tool:**
```python
@tool
async def memory_list(agent_name, scope, limit) -> str:
    """List all stored memories for debugging"""
```

**Test Results:**
- 18 MCP memory tests passed (5 new tests for memory_list)
- All scopes working correctly

---

### Issue #357: [DEV] Improve Tool Descriptions for Better LLM Decision Making
**Status:** Closed
**PR:** #359
**Impact:** Medium - LLM decision accuracy

**Implementation:**
- Description-driven behavior pattern
- "Use this tool when" / "Do NOT use for" セクション追加
- Enhanced parameter descriptions
- Multiple practical examples

**Modified Tools (8 tools):**

**Priority 1: Web Search**
- `brave_web_search`: Latest info vs general knowledge guidance
- `brave_news_search`: Breaking news and freshness filters
- `fact_check_claim`: Verification scenarios

**Priority 2: File Operations**
- `file_read`: File access scenarios
- `file_write`: Save/create guidance
- `dir_list`: Pattern exploration

**Priority 3: YouTube**
- `youtube_summarize`: Content understanding
- `youtube_fact_check`: Video claim verification

**Changes:**
- `src/kagura/mcp/builtin/brave_search.py`: +46 -15
- `src/kagura/mcp/builtin/fact_check.py`: +27 -7
- `src/kagura/mcp/builtin/file_ops.py`: +68 -25
- `src/kagura/mcp/builtin/youtube.py`: +46 -15

**Test Results:**
- 55 MCP builtin tests passed
- No behavior changes (description only)

---

### Issue #360: [BUG] memory_list fails with working scope
**Status:** Closed
**PR:** #361
**Impact:** High - Critical bug fix

**Root Cause:**
- `limit` parameter not converted to int before slicing
- LLM passes parameters as strings

**Fix:**
```python
# Ensure limit is int (LLM might pass as string)
if isinstance(limit, str):
    try:
        limit = int(limit)
    except ValueError:
        limit = 50
```

**Test Results:**
- All 5 memory_list tests pass
- Working and persistent scopes both functional

---

## Release: v3.0.8

**Release Date:** 2025-10-23
**GitHub Release:** https://github.com/JFK/kagura-ai/releases/tag/v3.0.8
**PyPI:** Auto-deployed via GitHub Actions

### Release Content

**Version Updates:**
- `pyproject.toml`: 3.0.7 → 3.0.8
- `CHANGELOG.md`: v3.0.8 section added
- `docs/en/guides/claude-code-mcp-setup.md`: memory_list追加

**Merged PRs:**
- #356: enable_rag auto-detect
- #358: Memory tool descriptions + memory_list
- #359: Other tool descriptions
- #361: memory_list bug fix
- #362: Release preparation

### Key Features

**New:**
- memory_list tool
- enable_rag auto-detection

**Enhanced:**
- 9 MCP tool descriptions improved
- Cross-thread memory sharing guidance

**Fixed:**
- memory_list TypeError
- Metadata mutation bug

---

## Statistics

**Issues Closed:** 5 (#354, #355, #357, #360, and related)
**PRs Merged:** 5 (#356, #358, #359, #361, #362)
**Lines Changed:** ~500+ additions, ~100 deletions
**Tests Added:** 8+ new tests
**Files Modified:** 15+

**Time Spent:** ~3-4 hours
**Test Pass Rate:** 100% (all memory-related tests)

---

## Technical Achievements

### Code Quality
- ✅ All tests passing (1300+ tests)
- ✅ Type checking: 0 errors
- ✅ Linting: All checks passed
- ✅ No breaking changes
- ✅ Full backward compatibility

### Architecture Improvements
- **Auto-detection Pattern**: Smart defaults with explicit overrides
- **Description-driven Behavior**: LLM guidance through enhanced docstrings
- **Consistent API**: Uniform parameter handling across tools

### User Experience
- **Better Defaults**: RAG auto-enables when available
- **Cross-thread Sharing**: agent_name="global" pattern
- **Debugging Tools**: memory_list for troubleshooting
- **Clear Guidance**: Tool descriptions help LLM decision making

---

## Lessons Learned

### What Worked Well
1. **Issue #357 Pattern**: Description-driven behavior change
   - No code changes needed
   - LLM learns from context
   - Effective and maintainable

2. **Auto-detect Pattern**: Smart defaults
   - Better UX out of the box
   - Graceful degradation
   - Explicit overrides still available

3. **Rapid Iteration**: 5 PRs in single session
   - Clear issue definitions
   - Focused scope per PR
   - Fast review and merge

### Technical Insights
1. **Type Conversion**: LLM passes parameters as strings
   - Always validate and convert types
   - Consistent pattern across tools
   - Avoid runtime errors

2. **Metadata Immutability**: Don't modify caller's data
   - Use `.copy()` before modifications
   - Prevents unexpected side effects

3. **Documentation as Code**: Rich docstrings
   - Guides LLM behavior
   - Self-documenting APIs
   - Better than separate documentation

---

## Next Steps

### Immediate
- ✅ v3.0.8 released
- ✅ PyPI deployment in progress
- ⏳ Wait for PyPI publish confirmation

### Short-term (Next Release)
- Monitor user feedback on new features
- Consider additional tool description enhancements
- Evaluate memory_list usage patterns

### Long-term
- Continue description-driven behavior pattern
- Expand auto-detect to other features
- Improve LLM decision making guidance

---

## References

**Issues:**
- #354: enable_rag default RFC
- #355: Memory cross-thread sharing
- #357: Tool descriptions improvement
- #360: memory_list bug

**PRs:**
- #356: Auto-detect implementation
- #358: Memory tool descriptions
- #359: Other tool descriptions
- #361: Bug fix
- #362: Release preparation

**Documentation:**
- CHANGELOG.md
- docs/en/api/memory.md
- docs/en/guides/claude-code-mcp-setup.md

---

**End of Work Log - 2025-10-23**
