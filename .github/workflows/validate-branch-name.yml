# Branch Name Validation Workflow
# Ensures all PRs follow the naming convention defined in BRANCH_POLICY.md
#
# Supported patterns (v4.1.1+):
#   1. Feature: {issue-number}-{type}/{description}
#   2. Release: v{major}.{minor}.{patch}-release
#   3. Hotfix:  hotfix/{description} (emergencies only)
#   4. Legacy:  {issue-number}-{type}-{description} (grandfathered)

name: Validate Branch Name

on:
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches-ignore:
      - main
      - develop
      - dev

jobs:
  validate:
    name: Check branch naming
    runs-on: ubuntu-latest

    steps:
      - name: Validate branch name format
        run: |
          # Extract branch name from PR head ref or current ref
          # ${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
          # - For PRs: GITHUB_HEAD_REF contains source branch name
          # - For pushes: Extract from GITHUB_REF by removing refs/heads/ prefix
          BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"

          echo "üîç Checking branch name: $BRANCH"

          # Allow protected branches
          if [[ "$BRANCH" =~ ^(main|develop|dev)$ ]]; then
            echo "‚úÖ Protected branch: $BRANCH"
            exit 0
          fi

          # Allow release branches: v{major}.{minor}.{patch}-release
          if [[ "$BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-release$ ]]; then
            echo "‚úÖ Release branch: $BRANCH"
            exit 0
          fi

          # Allow hotfix branches: hotfix/{description}
          if [[ "$BRANCH" =~ ^hotfix/[a-z0-9-]+$ ]]; then
            echo "‚úÖ Hotfix branch: $BRANCH"
            exit 0
          fi

          # Standard pattern: {number}-{type}/{description}
          if [[ "$BRANCH" =~ ^[0-9]+-[a-z]+/[a-z0-9-]+$ ]]; then
            echo "‚úÖ Valid format: {issue}-{type}/{description}"
            echo "Branch name: $BRANCH"
            exit 0
          fi

          # Legacy pattern: {number}-{type}-{description} (grandfathered)
          if [[ "$BRANCH" =~ ^[0-9]+-[a-z]+-[a-z0-9-]+$ ]]; then
            echo "‚ö†Ô∏è  Legacy format accepted: {issue}-{type}-{description}"
            echo "Branch name: $BRANCH"
            echo ""
            echo "Note: This format is deprecated. Please use:"
            echo "  {issue}-{type}/{description}"
            echo "  Example: 565-fix/integration-tests"
            exit 0
          fi

          # If we get here, branch name is invalid
          echo "‚ùå Invalid branch name: $BRANCH"
          echo ""
          echo "Allowed patterns:"
          echo ""
          echo "  1. Feature/Fix:  {issue-number}-{type}/{description}"
          echo "     Examples:     548-perf/cli-startup"
          echo "                   555-refactor/cli-structure"
          echo ""
          echo "  2. Release:      v{major}.{minor}.{patch}-release"
          echo "     Examples:     v4.1.1-release"
          echo "                   v5.0.0-release"
          echo ""
          echo "  3. Hotfix:       hotfix/{description} (emergencies only)"
          echo "     Example:      hotfix/critical-bug"
          echo ""
          echo "  4. Legacy:       {issue}-{type}-{description} (grandfathered)"
          echo ""
          echo "Valid types: feat, fix, perf, refactor, docs, test, chore"
          echo ""
          echo "üìö See .github/BRANCH_POLICY.md for complete workflow guide"
          exit 1

      - name: Branch age check
        run: |
          # Future enhancement: warn if branch is >7 days old
          echo "‚ÑπÔ∏è  Branch age check (not yet implemented)"
